{
  "type": "step_based",
  "name": "val_test",
  "active": true,
  "creationTag": {
    "versionNumber": 45,
    "lastModifiedBy": {
      "login": "kundan.singh@rsystems.com"
    },
    "lastModifiedOn": 1682509679049
  },
  "versionTag": {
    "versionNumber": 46,
    "lastModifiedBy": {
      "login": "kundan.singh@rsystems.com"
    },
    "lastModifiedOn": 1682509773327
  },
  "checklists": {
    "checklists": []
  },
  "delayedTriggersBehavior": {
    "delayWhileRunning": true,
    "squashDelayedTriggers": true,
    "suppressTriggersWhileRunning": true
  },
  "tags": [],
  "triggers": [
    {
      "id": "1NuUTuRs",
      "type": "temporal",
      "name": "Time-based",
      "delay": 5,
      "active": true,
      "params": {
        "repeatFrequency": 1,
        "frequency": "Hourly",
        "startingFrom": "2023-04-25T08:44:00.000Z",
        "daysOfWeek": [
          "Tuesday"
        ],
        "monthlyRunOn": "ON_THE_DAY",
        "minute": 14,
        "hour": 14,
        "timezone": "SERVER",
        "lastUpdate": 1682509773327
      }
    }
  ],
  "reporters": [
    {
      "active": true,
      "messaging": {
        "type": "mail-scenario",
        "configuration": {
          "channelId": "Kundan Singh",
          "subject": "DSS scenario ${scenarioName}: ${outcome}",
          "recipient": "kundansinghsorout9@gmail.com",
          "sendAsHTML": false,
          "attachments": [],
          "messageSource": "INLINE",
          "templateFormat": "FREEMARKER",
          "templateName": "default.ftl",
          "message": "Hi Your Validation test cases has been started to run."
        }
      },
      "id": "iMRO6RX9",
      "name": "send mail",
      "runConditionEnabled": false,
      "runCondition": "outcome !\u003d \u0027SUCCESS\u0027",
      "phase": "START"
    },
    {
      "active": true,
      "messaging": {
        "type": "shell-scenario",
        "configuration": {
          "sendEverythingAsVariables": false,
          "variables": []
        }
      },
      "id": "e8YqEiUt",
      "name": "Pytest command",
      "runConditionEnabled": true,
      "runCondition": "outcome !\u003d \u0027SUCCESS\u0027",
      "phase": "END"
    }
  ],
  "params": {
    "steps": [
      {
        "id": "build_0_true_d_preprocessed_data",
        "type": "build_flowitem",
        "name": "Step #1",
        "runConditionType": "DISABLED",
        "runConditionStatuses": [
          "SUCCESS",
          "WARNING"
        ],
        "runConditionExpression": "",
        "resetScenarioStatus": false,
        "delayBetweenRetries": 10,
        "maxRetriesOnFail": 0,
        "params": {
          "builds": [
            {
              "type": "DATASET",
              "itemId": "preprocessed_data",
              "partitionsSpec": ""
            }
          ],
          "jobType": "RECURSIVE_BUILD",
          "refreshHiveMetastore": true,
          "handleWarningsAs": "WARNING",
          "proceedOnFailure": false
        }
      },
      {
        "id": "build_0_true",
        "type": "build_flowitem",
        "name": "Step #2",
        "runConditionType": "DISABLED",
        "runConditionStatuses": [
          "SUCCESS",
          "WARNING"
        ],
        "runConditionExpression": "",
        "resetScenarioStatus": false,
        "delayBetweenRetries": 10,
        "maxRetriesOnFail": 0,
        "params": {
          "builds": [
            {
              "type": "SAVED_MODEL",
              "itemId": "wjL6zeFP",
              "partitionsSpec": ""
            }
          ],
          "jobType": "RECURSIVE_BUILD",
          "refreshHiveMetastore": true,
          "handleWarningsAs": "WARNING",
          "proceedOnFailure": false
        }
      },
      {
        "id": "check_WARNING_d_preprocessed_data_m_wjL6zeFP",
        "type": "check_dataset",
        "name": "Step #3",
        "runConditionType": "DISABLED",
        "runConditionStatuses": [
          "SUCCESS",
          "WARNING"
        ],
        "runConditionExpression": "",
        "resetScenarioStatus": false,
        "delayBetweenRetries": 10,
        "maxRetriesOnFail": 0,
        "params": {
          "checks": [
            {
              "type": "DATASET",
              "itemId": "preprocessed_data",
              "partitionsSpec": ""
            },
            {
              "type": "SAVED_MODEL",
              "itemId": "wjL6zeFP",
              "partitionsSpec": ""
            }
          ],
          "handleWarningsAs": "WARNING",
          "proceedOnFailure": false
        }
      },
      {
        "id": "check_consistency",
        "type": "check_consistency",
        "name": "Step #4",
        "runConditionType": "DISABLED",
        "runConditionStatuses": [
          "SUCCESS",
          "WARNING"
        ],
        "runConditionExpression": "",
        "resetScenarioStatus": false,
        "delayBetweenRetries": 10,
        "maxRetriesOnFail": 0,
        "params": {
          "handleWarningsAs": "WARNING",
          "proceedOnFailure": false
        }
      },
      {
        "id": "comp_metrics_d_preprocessed_data",
        "type": "compute_metrics",
        "name": "Step #5",
        "runConditionType": "DISABLED",
        "runConditionStatuses": [
          "SUCCESS",
          "WARNING"
        ],
        "runConditionExpression": "",
        "resetScenarioStatus": false,
        "delayBetweenRetries": 10,
        "maxRetriesOnFail": 0,
        "params": {
          "computes": [
            {
              "type": "DATASET",
              "itemId": "preprocessed_data",
              "partitionsSpec": ""
            }
          ],
          "proceedOnFailure": false
        }
      },
      {
        "id": "custom_python_pCReIxQEK87YrOkzGzv/YA",
        "type": "custom_python",
        "name": "Step #7",
        "runConditionType": "RUN_IF_STATUS_MATCH",
        "runConditionStatuses": [
          "SUCCESS",
          "WARNING"
        ],
        "runConditionExpression": "",
        "resetScenarioStatus": false,
        "delayBetweenRetries": 10,
        "maxRetriesOnFail": 0,
        "params": {
          "script": "# -*- coding: utf-8 -*-\nimport dataiku\nimport pandas as pd, numpy as np\nfrom dataiku import pandasutils as pdu\n\nfrom sklearn.metrics import precision_score, recall_score\nfrom sklearn.preprocessing import MultiLabelBinarizer, LabelEncoder\n\n# Read recipe inputs\npreprocessed_data \u003d dataiku.Dataset(\"preprocessed_data\")\npreprocessed_data_df \u003d preprocessed_data.get_dataframe()\n\nclient \u003d dataiku.api_client()\nproject \u003d client.get_project(\"cicd with internal git\")\n#print(\"##################3\", project)\nall_models \u003d dataiku.Model(\"cicd with internal git\").list_models()\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e I AM HERE\")\n#print(all_models)\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e END HERE\")\n\n# latest_model \u003d dataiku.Model(\"cicd with internal git\").latest_model()\nlatest_model_id \u003d all_models[0][\"id\"]\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003elatest_model_id\", latest_model_id)\nm \u003d dataiku.Model(latest_model_id)\nmy_predictor \u003d m.get_predictor()\nmy_clf \u003d my_predictor._clf\n\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003emy_clf\", my_clf)\n\n\ny_test \u003d preprocessed_data_df[:10000][\"POL_STATUS\"]\ny_predict \u003d my_predictor.predict(preprocessed_data_df[:10000].drop(columns\u003d[\"POL_STATUS\"]))[\"prediction\"]\n\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003ey_predict\",y_predict.shape, y_predict)\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003ey_test\",y_test.shape, y_test)\n\n# le \u003d MultiLabelBinarizer()\nle \u003d LabelEncoder()\nle.fit(list(y_test))\n\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003eHERE I AM\")\n\n\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003ele.transform(y_test)\", le.transform(list(y_test)).shape, le.transform(list(y_test)))\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003ele.transform(y_predict)\", le.transform(y_predict).shape, le.transform(y_predict))\n\np_score \u003d precision_score(\n          le.transform(list(y_test)), \n          le.transform(y_predict),\n          average\u003d\u0027macro\u0027\n      )\n#print(\"\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003eprecision_score\", p_score) \n      \n# dataiku.\n#print(preprocessed_data_df.head(2))\n\n\nif p_score \u003e 0.5:\n    print(\"Push the code to Master\")\nelse:\n    print(\"Don\u0027t push the code\")\n\n",
          "envSelection": {
            "envMode": "INHERIT",
            "envName": "dash"
          },
          "proceedOnFailure": false
        }
      },
      {
        "id": "report762a073cc27e52cfe925d82a35f0fadc",
        "type": "send_report",
        "name": "Step #6",
        "runConditionType": "RUN_IF_STATUS_MATCH",
        "runConditionStatuses": [
          "SUCCESS",
          "WARNING"
        ],
        "runConditionExpression": "",
        "resetScenarioStatus": false,
        "delayBetweenRetries": 10,
        "maxRetriesOnFail": 0,
        "params": {
          "failOnMessageNotSent": true,
          "messaging": {
            "type": "mail-scenario",
            "configuration": {
              "channelId": "Kundan Singh",
              "subject": "DSS scenario ${scenarioName}: ${outcome}",
              "recipient": "kundan.singh@rsystems.com",
              "sendAsHTML": false,
              "attachments": [],
              "messageSource": "INLINE",
              "templateFormat": "FREEMARKER",
              "templateName": "default.ftl",
              "message": "Hi \n\n    Sending message for compute metrics."
            }
          }
        }
      }
    ]
  },
  "automationLocal": false,
  "customFields": {}
}